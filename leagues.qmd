---
title: "Leagues"
format: html
---

```{r setup, include=FALSE}
library(dplyr)
library(readr)
library(ggplot2)
library(scales)
library(tidyr)
library(reactable)
library(ggrepel)

league_season <- read_csv("data/derived/player_by_league_season.csv", show_col_types = FALSE)
```

## Coverage Summary

```{r league-summary, echo=FALSE}
league_total <- league_season %>%
  group_by(league) %>%
  summarise(
    seasons = n_distinct(season),
    players = n_distinct(player),
    runs = sum(runs_scored, na.rm = TRUE),
    wickets = sum(wickets, na.rm = TRUE),
    avg_sr = 100 * sum(runs_scored, na.rm = TRUE) / sum(balls_faced, na.rm = TRUE),
    avg_eco = sum(runs_conceded, na.rm = TRUE) / (sum(balls_bowled, na.rm = TRUE) / 6),
    .groups = "drop"
  )

reactable(
  league_total,
  columns = list(
    league = colDef(name = "League"),
    seasons = colDef(name = "Seasons"),
    players = colDef(name = "Players"),
    runs = colDef(name = "Runs", format = colFormat(digits = 0)),
    wickets = colDef(name = "Wickets", format = colFormat(digits = 0)),
    avg_sr = colDef(name = "Avg SR", format = colFormat(digits = 1)),
    avg_eco = colDef(name = "Avg Econ", format = colFormat(digits = 2))
  ),
  defaultPageSize = 12
)
```

## Seasonal Volume Map

```{r league-heatmap, echo=FALSE, fig.width=9, fig.height=5}
heat_data <- league_season %>%
  group_by(league, season) %>%
  summarise(runs = sum(runs_scored, na.rm = TRUE), .groups = "drop") %>%
  mutate(season = factor(season, levels = sort(unique(season))))

ggplot(heat_data, aes(season, league, fill = runs)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#e0f3ff", high = "#00509d", labels = label_number_si()) +
  labs(
    x = "Season",
    y = NULL,
    fill = "Runs",
    title = "Runs generated by league-season",
    subtitle = "Quick matrix to see coverage density and big-scoring tournaments"
  ) +
  theme_minimal(base_family = "Inter") +
  theme(axis.text.y = element_text(face = "bold"))
```

## Balance of Power

```{r league-balance, echo=FALSE, fig.width=8, fig.height=5}
balance <- league_season %>%
  group_by(league) %>%
  summarise(
    strike_rate = 100 * sum(runs_scored, na.rm = TRUE) / sum(balls_faced, na.rm = TRUE),
    economy = sum(runs_conceded, na.rm = TRUE) / (sum(balls_bowled, na.rm = TRUE) / 6),
    matches = n_distinct(paste(league, season)),
    .groups = "drop"
  )

ggplot(balance, aes(strike_rate, economy)) +
  geom_point(aes(size = matches), color = "#d7263d", alpha = 0.8) +
  ggrepel::geom_text_repel(aes(label = league), size = 3, max.overlaps = 20) +
  scale_size_continuous(range = c(3, 10), name = "League-Seasons") +
  labs(
    x = "Aggregate strike rate",
    y = "Aggregate economy",
    title = "How each league plays",
    subtitle = "Strike rate vs bowling economy (ALL seasons)"
  ) +
  theme_minimal(base_family = "Inter")
```

## Consistency Index

```{r league-consistency, echo=FALSE, fig.width=8, fig.height=5}
consistency <- league_season %>%
  group_by(league, season) %>%
  summarise(sr = 100 * sum(runs_scored, na.rm = TRUE) / sum(balls_faced, na.rm = TRUE), .groups = "drop")

consistency %>%
  arrange(season) %>%
  ggplot(aes(x = season, y = sr, group = league, color = league)) +
  geom_line(alpha = 0.4) +
  geom_point(alpha = 0.6) +
  labs(
    x = "Season",
    y = "League strike rate",
    title = "Strike rate trends over time",
    subtitle = "Thin multi-series view: highlight volatility or stability"
  ) +
  theme_minimal(base_family = "Inter") +
  theme(legend.position = "none")
```
